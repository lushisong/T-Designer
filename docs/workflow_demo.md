# T-Designer 工作流程演示指南

本指南以一个**最小示例项目**演示系统从元件建模到测试决策树生成的完整九步流程。目标是在明早验收前，你可以照此快速跑通所有界面与业务逻辑；细节优化和更复杂的模型可以在下一阶段逐步完善。

> 💡 **快捷生成演示工程**：在主界面按下 `Ctrl + Shift + H`，系统会在 `C:/TBD/MyProjects/DemoWorkflow` 下自动创建并载入演示项目（含 `Model.db`、`.swPro`、`.db` 等文件）。重复按下快捷键可重新生成，便于恢复初始状态。

> ⚠️ **首次同步代码后请先重新生成工程文件**：
>
> ```bat
> cd build
> qmake ..\T_DESIGNER.pro
> ```
>
> 由于环境中缺少 `QtAxContainer`，若命令提示 `Unknown module(s) in QT: axcontainer`，只需在具备完整 Qt 5.12 环境的机器上执行一次即可。本地运行时功能不受影响。

## 前置准备

1. 启动 T-Designer，确认已打开目标工程（可使用演示项目或新建空工程）。
2. 在主界面「设计」工具栏中新增了 `功能管理` 按钮，以及 `树视图 ▸ 功能子块` 的右键菜单 `创建功能`。
3. `容器树` 对话框中，右键菜单提供 `管理测试`，进入改造后的测试管理器。

---

## Step 1：添加实体元件

1. 在左侧 `treeViewUnits` 中，右键需要的层级（项目/高层/位置），选择「新建元件」。
2. 示例：新建两个元件
   - 电源模块 `PSU-1`
   - 执行器模块 `ACT-1`
3. 保存后，确认每个元件在树节点的 `WhatsThisRole` 为「元件」。

> 提示：若已存在模板，可使用「新建子块(模板)」直接加载子块。

---

## Step 2：定义功能（输入期望输出模式）

1. 在 `treeViewUnits` 中选中 `ACT-1` 的子块，右键选择 **「创建功能」**。
2. 弹出的功能编辑器会自动分析：
   - `链路` 与 `器件依赖`（根据布线生成）
   - 默认的执行器端口、故障概率（可手动调整）
3. 输入示例：
   - 名称：`DeliverPressure`
   - 备注：`泵站在 24V 输入下提供 8bar 输出`
   - 约束：
     - 变量 `PSU-1.U` = `24V`
     - 输出 `ACT-1.pressure` = `8bar`
4. 保存后，功能会写入工程数据库，并可在 `功能管理` 对话框中查看/编辑。

> 功能之间若存在依赖，可在功能编辑器中配置「依赖功能」列表；自动解析器会在测试阶段复用这些关系。

---

## Step 3：构建分层模型

1. 打开「设计 ▸ 层次模型」(`Btn_ContainerTree`)。
2. 为每个实体元件创建对应的容器节点：右键 `元件` → 「为实体元件添加元件层容器」。
3. 若需要上层结构（系统/子系统），通过右键菜单新增并拖放或使用提供的「添加到高层级容器」操作建立层级关系。
4. 在本示例中，可创建：
   - `System`（系统层）
   - `Subsystem-Fluid`（子系统层）
   - 将 `ACT-1`、`PSU-1` 对应的组件容器挂到 `Subsystem-Fluid` 下。

---

## Step 4：自动创建测试（元件层）

1. 在容器树中选中 `ACT-1` 对应的容器，右键选择「管理测试」。
2. 在弹出的测试管理器中点击「自动生成」：
   - **信号类测试**：针对端口自动生成（电压、电流、压力等）
   - **功能类测试**：根据 Step 2 中的功能自动生成虚拟测试
   - **故障模式测试**：根据行为模型生成正常判别和故障模式判别
3. 每个测试默认带有估计 `费用` 与 `时间`（Signal=1，Function=2，FaultMode=3，可在编辑器中修改）。
4. 如需手动调整，可使用「新增」「编辑」「删除」按钮；修改后顶部标题会出现 `*` 提示未保存。

---

## Step 5：构建测试性模型（D 矩阵）

1. 在测试管理器的 `依赖矩阵` 标签页可查看自动生成的检测/隔离矩阵：
   - 表格列示 `测试-故障` 对应关系以及可检测/可隔离标志
   - 下方文本信息统计当前覆盖情况
2. 任何对测试列表的修改都会实时更新矩阵。

---

## Step 6：输入并分解测试性指标

1. 切换到 `指标分解` 标签页。
2. 在「故障检测率目标」「故障隔离率目标」中输入系统层指标（示例：检测 0.8，隔离 0.6）。
3. 点击「分配目标」，系统会为当前容器及其子容器生成默认分配表（目前按平均分配，后续可引入加权算法）。
4. 分配结果会保存到容器的 `analysis_json` 字段，后续可继续调整。

---

## Step 7：施加多维约束并筛选候选测试

1. 在 `约束筛选` 标签页设置：
   - 最大测试费用（示例：`6`）
   - 最大测试时间（示例：`6`）
   - 最大测试数量（示例：`3`，`0` 表示无限制）
2. 点击「筛选候选测试」，系统将依据启发式算法（按检测故障数降序、再按成本升序）选出候选集合。
3. 候选测试会展示在列表中，同时写入 `analysis_json ▸ candidates`。如果后续删减某个测试，列表会自动剔除无效 ID，并提示需重新保存。

---

## Step 8：预测候选集的测试性指标

1. 进入 `指标预测` 标签页，点击「重新评估」。
2. 系统会基于 D 矩阵和当前候选集计算：
   - 覆盖故障数/总故障数
   - 检测率、隔离率（百分比和小数）
3. 结果将显示在摘要文本和明细表格中，并写入 `analysis_json ▸ prediction`，便于后续分析。

---

## Step 9：生成故障诊断决策树

1. 切换到 `决策树` 标签页。
2. 点击「生成决策树」，算法会基于候选测试集构造一棵简单的判决树：
   - 非叶节点显示选用的测试编号
   - 叶节点展示隔离出的故障（或“未隔离故障”）
3. 树结构同时转换为易读的文本摘要，并以层级 JSON 的形式存储在 `analysis_json ▸ decisionTree`，便于将来导出或进一步可视化。

---

## 保存与退出

- 点击测试管理器底部的「保存」，所有测试、指标、候选集及决策树数据会落入数据库。
- 若关闭对话框时存在未保存修改，会弹出提示（可选择保存或放弃）。
- 在主界面中，可随时再次打开 `功能管理`、`容器树`、`测试管理` 查看和继续完善模型。

---

## 后续扩展建议

1. **算法增强**：指标分配、候选筛选目前采用均分/启发式策略，可逐步引入基于权重或线性规划的严谨算法。
2. **数据持久化扩展**：`analysis_json` 已预留接口，可继续记录测试复杂度、测试组合、优化结果等。
3. **可视化**：决策树 JSON 已生成，可在后续版本中接入图形化展示或导出。
4. **批量脚本**：可考虑为演示项目编写初始化脚本，以一键复现本文示例数据。

> 至此，一个完整的“元件 → 功能 → 容器 → 测试 → 指标 → 决策”闭环已打通。后续只需在此基础上逐步细化模型和算法，即可落地更复杂的工程实践。
