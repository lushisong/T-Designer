# T语言端口映射与建模规范

## 1. 端口编号与 CAD 连线

- **端口来源**：每个实体元件（Equipment）在 `Symbol`/`Symb2TermInfo` 中维护功能子块与端口清单。
  - `Symbol.Show_DT`：功能子块外显代号。
  - `Symb2TermInfo.ConnNum`：该功能子块下的端号（在元件属性对话框中使用 `|` 分隔展示）。
- **CAD 连线对应关系**：
  1. 端口在 CAD 中被捕捉后写入 `ConnectLine`，记录两端的 `Symb2TermInfo_ID` 与端子/端子排分类。
  2. `ProduceDBJXB()` 将 `ConnectLine` 归并为 `JXB`（导线表），形成端口与连线的一一映射。
  3. 诊断/链路算法通过 `GetLinkRoadByUnitStripID()` 遍历 `JXB` + `Symb2TermInfo`，即可从端号追踪到 CAD 连线网络。

## 2. T 语言端口变量规范

- **命名模板**：所有端口变量必须遵循 `%(单元代号)%.(端号).(量纲)` 或 `单元代号.端号.量纲`。
  - `单元代号`：元件 DT 号或子系统实例，例如 `%FU%`、`FU1`。
  - `端号`：来自 `Symb2TermInfo.ConnNum`，需在元件内部唯一（允许字母、数字、下划线、短横）。
  - `量纲`：`u` 表示端电位（或通用输出量），`i` 表示端流量/输入量。
- **声明要求**：每个端号至少存在一条 `declare-fun`，分别声明 `.u` 与 `.i` 变量，例如：
  ```smt
  (declare-fun %FU%.1.u () Real)
  (declare-fun %FU%.1.i () Real)
  ```
- **引用要求**：端口变量应在断言或子表达式中参与约束，避免悬空声明。
- **参数占位符**：设备参数（如 `Resistance`）允许使用 `%参数名%`，但禁止与端号命名冲突。
- **多实例共享**：库中 T 语言必须保留 `%单元代号%` 占位符，工程落地后由 `ReplaceMarkToTag()` 使用实际 DT 号替换，无需修改模型内容。

## 3. 校验逻辑

`TModelValidator` 依据上述规范执行以下检查：

1. **映射生成**：解析 SMT，提取所有端口变量，并与 `Symb2TermInfo` 的端号集合建立映射。
2. **声明完整性**：缺失 `.u` 或 `.i` 的端号，记录为 `missingDeclarations`。
3. **无定义引用**：存在于 SMT 中但无对应端号的变量，落入 `undefinedVariables`（通常是端号拼写错误或模型未同步）。
4. **未使用端口**：端号未在公式中出现，仅提示为 `unusedPorts` 供开发者确认。
5. **格式错误**：没有端号、端号为空等场景直接标记 `formatErrors`，阻断后续校验。

> 通过校验（`result.isValid() == true`）意味着端口-变量映射完整且未发现非法引用；仍需关注 `unusedPorts` 和 `hints`，以提升模型质量。

## 4. 建模建议

- 在库中维护统一的端号与信号方向，避免多实例间端号含义不一致。
- 端号、变量、测试描述务必同步维护，新增/删除端口后立即重新执行“校验端口映射”。
- 子模块或派生模型可使用前缀区分端号，例如 `K1_13`，确保全局唯一性，便于自动化工具识别。

